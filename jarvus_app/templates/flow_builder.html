{% extends "base.html" %}

{% block title %}Flow Builder - Jarvus{% endblock %}

{% block content %}
<!-- ────────────────────────────────────────────────────────────────────────
MAIN PAGE: "Workflows" HEADER, ADD BUTTON, AND GRID OF CARDS
──────────────────────────────────────────────────────────────────────── -->
<main class="container">
    <h1 class="mt-4">Workflows</h1>

    <!-- "+ Add Workflow" button -->
    <button id="addWorkflowBtn" class="cta-button mt-4">+ Add Workflow</button>

    <!-- Grid where workflow cards will be rendered -->
    <div class="workflows-grid mt-4" id="workflowsGrid">
        <!-- JS will populate this from the mock database -->
    </div>
</main>


<!-- ────────────────────────────────────────────────────────────────────────
    MODAL OVERLAY (HIDDEN BY DEFAULT) CONTAINING FLOW‐BUILDER UI
    ──────────────────────────────────────────────────────────────────────── -->
<div class="modal-overlay" id="workflowModal">
<div class="modal">

    <!-- "X" CLOSE BUTTON -->
    <button class="modal-close" id="modalCloseBtn">&times;</button>

    <!-- WORKFLOW TITLE (editable) -->
    <input
    type="text"
    id="modalWorkflowTitle"
    class="step-input"
    placeholder="Workflow Title"
    style="font-size: 1.25rem; font-weight: 600; width: 100%; margin-bottom: var(--spacing-md);"
    />

    <!-- FLOW BUILDER CONTAINER: STEPS APPEAR HERE VIA JS -->
    <div class="workflow-container" id="flowContainer">
    <!--
        JavaScript will insert <div class="step">…</div> elements here,
        each built from the <template id="stepTemplate"> below.
    -->

    <!-- "Add step" button lives at the end of #flowContainer -->
    <button class="add-step-btn mt-4" id="addStepBtn">Add step</button>
    </div>

    <!-- SAVE + CANCEL BUTTONS FOR THE WORKFLOW -->
    <div class="mt-4" style="text-align: right;">
    <button id="cancelWorkflowBtn" class="cta-button" style="background: var(--error-color); margin-right: var(--spacing-md);">
        Cancel
    </button>
    <button id="saveWorkflowBtn" class="cta-button">Save Workflow</button>
    </div>

</div>
</div>


<!-- ────────────────────────────────────────────────────────────────────────
    HIDDEN <template> FOR ONE "step" 
    (JS will clone this whenever you Add or load a step)
    ──────────────────────────────────────────────────────────────────────── -->
<template id="stepTemplate">
<div class="step">
    <!-- STEP HEADER: a dropdown to choose type "Instruction" or "Action" -->
    <div class="step-header">
    <select class="step-type-select">
        <option value="Instruction">Instruction</option>
        <option value="Action">Action</option>
    </select>
    </div>

    <!-- STEP BODY: editable description area -->
    <div class="step-body">
    <textarea
        class="step-input"
        rows="2"
        placeholder="Enter step description…"
    ></textarea>
    <div class="step-footer">
        <span class="attachment-icon">📎</span>
        <span class="typing-indicator">Aa</span>
        <span class="mention-icon">@</span>
    </div>
    </div>
</div>
</template>


<!-- ────────────────────────────────────────────────────────────────────────
    JAVASCRIPT: mock "database", rendering logic, modal open/close, and save
    ──────────────────────────────────────────────────────────────────────── -->
<script>
// ──────────────────────────────────────────────────────────────────────────
// 1. MOCK DATABASE (an array of workflows)
// ──────────────────────────────────────────────────────────────────────────
let mockWorkflows = [
    {
        id: 1,
        title: 'Sales Analysis',
        description: 'Automated analysis of sales data and generation of insights',
        type: 'Analytics',
        steps: [
            { type: 'Instruction', description: 'Analyse the financial figures in @ Delta Dashboard' },
            { type: 'Instruction', description: 'Analyse product metrics in @ Sana AI metrics' },
            { type: 'Instruction', description: 'Consolidate into one concise report' },
            { type: 'Action', description: 'Write feedback on the report in @ Google Sheets' }
        ]
    },
    {
        id: 2,
        title: 'Marketing Report',
        description: 'Generate comprehensive marketing performance reports',
        type: 'Reporting',
        steps: [
            { type: 'Instruction', description: 'Gather social media analytics over last 30 days' },
            { type: 'Instruction', description: 'Compare CPC & CTR against benchmarks' },
            { type: 'Action', description: 'Produce slide deck in @ Google Slides' }
        ]
    },
    {
        id: 3,
        title: 'Customer Onboarding',
        description: 'Streamline new customer welcome and setup process',
        type: 'Process',
        steps: [
            { type: 'Instruction', description: 'Send welcome email to new customers' },
            { type: 'Instruction', description: 'Create support ticket in @ Zendesk' },
            { type: 'Action', description: 'Schedule product training via @ Calendly' }
        ]
    },
    {
        id: 4,
        title: 'Data Backup',
        description: 'Automated daily backup of critical business data',
        type: 'Maintenance',
        steps: [
            { type: 'Instruction', description: 'Collect all necessary files' },
            { type: 'Action', description: 'Create compressed backup archive' }
        ]
    }
];

// We'll maintain a variable to know which workflow is currently being edited.
// If "null", that means we're creating a brand‐new workflow.
let currentEditingId = null;


// ──────────────────────────────────────────────────────────────────────────
// 2. HELPER: RENDER ALL WORKFLOW CARDS FROM mockWorkflows
// ──────────────────────────────────────────────────────────────────────────
const workflowsGrid = document.getElementById('workflowsGrid');

function renderWorkflowCards() {
    const workflowsGrid = document.getElementById('workflowsGrid');
    workflowsGrid.innerHTML = '';

    mockWorkflows.forEach((wf) => {
        const template = document.getElementById('workflowCardTemplate');
        const card = template.content.cloneNode(true);
        const cardElement = card.querySelector('.workflow-card');
        
        // Set card content
        cardElement.querySelector('.workflow-title').textContent = wf.title;
        cardElement.querySelector('.workflow-description').textContent = wf.description;
        cardElement.querySelector('.workflow-steps').textContent = `${wf.steps.length} steps`;
        cardElement.querySelector('.workflow-type').textContent = wf.type;
        
        // Add click handler
        cardElement.addEventListener('click', () => {
            openModalForEditing(wf.id);
        });
        
        workflowsGrid.appendChild(cardElement);
    });
}

// ──────────────────────────────────────────────────────────────────────────
// 3. OPEN MODAL AND POPULATE WITH STEPS (OR BLANK FOR NEW)
// ──────────────────────────────────────────────────────────────────────────
const modalOverlay     = document.getElementById('workflowModal');
const modalCloseBtn    = document.getElementById('modalCloseBtn');
const cancelWorkflowBtn= document.getElementById('cancelWorkflowBtn');
const saveWorkflowBtn  = document.getElementById('saveWorkflowBtn');
const addWorkflowBtn   = document.getElementById('addWorkflowBtn');
const modalTitleInput  = document.getElementById('modalWorkflowTitle');
const flowContainer    = document.getElementById('flowContainer');
const addStepBtn       = document.getElementById('addStepBtn');
const stepTemplate     = document.getElementById('stepTemplate');

// Helper to clear all steps from the flow container (but keep the addStepBtn)
function clearAllSteps() {
    // Remove everything in flowContainer except the addStepBtn
    Array.from(flowContainer.children).forEach(child => {
    if (child !== addStepBtn) {
        flowContainer.removeChild(child);
    }
    });
}

// Helper to build a single step element (type + description) and append it
function appendStepToContainer(stepData = { type: 'Instruction', description: '' }) {
    // Clone the <template> 
    const clone = stepTemplate.content.cloneNode(true);
    const stepElement = clone.querySelector('.step');

    // Set the select value
    const select = stepElement.querySelector('select.step-type-select');
    select.value = stepData.type;

    // Set the textarea value
    const textarea = stepElement.querySelector('textarea.step-input');
    textarea.value = stepData.description;

    // Insert this .step just BEFORE the "Add step" button
    flowContainer.insertBefore(stepElement, addStepBtn);
}

// Open the modal to edit an existing workflow (by id) or create new one if id==null
function openModalForEditing(workflowId) {
    currentEditingId = workflowId;

    // 1. If workflowId !== null, we find that workflow in the mock DB
    if (workflowId !== null) {
    const wf = mockWorkflows.find(w => w.id === workflowId);
    if (wf) {
        // Populate the title input
        modalTitleInput.value = wf.title;

        // Clear existing steps, then append each step from wf.steps
        clearAllSteps();
        wf.steps.forEach(stepObj => {
        appendStepToContainer(stepObj);
        });
    }
    } else {
    // Creating a brand‐new workflow: blank title + no steps yet
    modalTitleInput.value = '';
    clearAllSteps();
    // (No steps appended until user clicks "Add step")
    }

    // Finally, show the modal overlay
    modalOverlay.style.display = 'flex';
}

// ──────────────────────────────────────────────────────────────────────────
// 4. SAVE WORKFLOW: read out all fields in the modal, update mockWorkflows,
//    then re‐render the cards and close the modal
// ──────────────────────────────────────────────────────────────────────────
function saveWorkflow() {
    const title = modalTitleInput.value.trim();
    if (title === '') {
    alert('Workflow must have a title.');
    return;
    }

    // Gather all steps in the flowContainer
    const stepElements = Array.from(flowContainer.querySelectorAll('.step'));
    const stepsArray = stepElements.map(stepEl => {
    const type = stepEl.querySelector('select.step-type-select').value;
    const description = stepEl.querySelector('textarea.step-input').value.trim();
    return { type, description };
    });

    if (currentEditingId !== null) {
    // Update existing workflow
    const idx = mockWorkflows.findIndex(w => w.id === currentEditingId);
    if (idx !== -1) {
        mockWorkflows[idx].title = title;
        mockWorkflows[idx].steps = stepsArray;
    }
    } else {
    // Create a new workflow object
    // Generate a new unique ID (simply 1 + max existing id)
    const newId =
        mockWorkflows.length > 0
        ? Math.max(...mockWorkflows.map(w => w.id)) + 1
        : 1;

    const newWorkflow = {
        id: newId,
        title: title,
        steps: stepsArray
    };
    mockWorkflows.push(newWorkflow);
    }

    // Re‐render the cards (so we see the new/updated workflow in the grid)
    renderWorkflowCards();
    closeModal();
}

// ──────────────────────────────────────────────────────────────────────────
// 5. CLOSE MODAL (hide overlay) WITHOUT SAVING
// ──────────────────────────────────────────────────────────────────────────
function closeModal() {
    modalOverlay.style.display = 'none';
    currentEditingId = null;
}


// ──────────────────────────────────────────────────────────────────────────
// 6. "ADD STEP" BUTTON: insert a blank step
// ──────────────────────────────────────────────────────────────────────────
addStepBtn.addEventListener('click', (e) => {
    e.preventDefault();
    appendStepToContainer();
    // scroll container to bottom so the new step is in view
    flowContainer.scrollTop = flowContainer.scrollHeight;
});


// ──────────────────────────────────────────────────────────────────────────
// 7. WIRING UP BUTTONS & INITIAL RENDER
// ──────────────────────────────────────────────────────────────────────────

// "Add Workflow" (creates brand‐new workflow)
addWorkflowBtn.addEventListener('click', () => {
    openModalForEditing(null);
});

// "×" close button in the modal
modalCloseBtn.addEventListener('click', closeModal);

// "Cancel" button in the modal
cancelWorkflowBtn.addEventListener('click', closeModal);

// "Save Workflow" button in the modal
saveWorkflowBtn.addEventListener('click', saveWorkflow);

// Also close modal when clicking outside the .modal (i.e. on the overlay)
modalOverlay.addEventListener('click', (e) => {
    if (e.target === modalOverlay) {
    closeModal();
    }
});

// On page load, render the existing workflows into cards:
document.addEventListener('DOMContentLoaded', () => {
    renderWorkflowCards();
});
</script>

<!-- Workflow Card Template -->
<template id="workflowCardTemplate">
    <div class="workflow-card">
        <div class="workflow-card-content">
            <h3 class="workflow-title"></h3>
            <p class="workflow-description"></p>
            <div class="workflow-meta">
                <span class="workflow-steps"></span>
                <span class="workflow-type"></span>
            </div>
        </div>
    </div>
</template>

{% endblock %}
