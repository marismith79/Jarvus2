{% extends "base.html" %}

{% block title %}Chatbot - Jarvus{% endblock %}

{% block content %}
<div class="chatbot-layout">
    <!-- Workspace Sidebar (empty for now) -->
    <aside class="workspace-sidebar"></aside>

    <!-- Chat Main Area -->
    <section class="chatbot-card">
        <!-- Greeting -->
        <div class="greeting-section">
            <h1 class="greeting-title">Hello, {{ current_user.name or 'User' }}</h1>
            <p class="greeting-subtitle">How can I help you today?</p>
        </div>

        <!-- Suggestions header -->
        <div class="suggestions-header" id="suggestions-header">
            <span class="suggestions-label">Suggestions</span>
            <button class="dropdown-btn">▾</button>
        </div>

        <!-- Suggestion cards -->
        <div class="suggestions-cards-wrapper" id="suggestions-wrapper">
            <div class="suggestions-cards">
                <div class="card card-gmail">
                    <div class="card-text gmail-text">
                        Check my recent emails
                    </div>
                    <div class="card-meta gmail-meta">
                        Last checked <br><span class="time">2 hours ago</span>
                    </div>
                </div>
                <div class="card card-calendar">
                    <div class="card-text calendar-text">
                        Show my upcoming events
                    </div>
                    <div class="card-meta calendar-meta">
                        Next event <br><span class="time">in 30 mins</span>
                    </div>
                </div>
                <div class="card card-salesforce">
                    <div class="card-text salesforce-text">
                        Update the opportunity to Signed
                    </div>
                    <div class="card-meta salesforce-meta">
                        Project ARR <br><span class="amount">$40,000</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat history -->
        <div id="chat-history" class="chat-history"></div>

        <!-- Chat input bar -->
        <form class="chat-input-bar" onsubmit="event.preventDefault(); sendCommand();">
            <div class="input-buttons">
                <button type="button" class="icon-btn input-plus">+</button>
                <div class="tool-selector">
                    <button type="button" class="icon-btn input-at" id="atButton">@</button>
                    <div class="tool-dropdown" id="toolDropdown">
                        <!-- Tool items will be populated dynamically -->
                    </div>
                </div>
            </div>
            <input type="text" id="chat-input" class="chat-input" placeholder="Ask or search for anything..." autocomplete="off">
            <button type="submit" class="icon-btn send-btn" id="send-btn">➔</button>
        </form>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Helper to append a message bubble into #chat-history
    function appendMessage(who, text) {
        const history = document.getElementById('chat-history');
        const wrapper = document.createElement('div');
        wrapper.classList.add('message', who);
        
        const p = document.createElement('p');
        p.textContent = text;
        wrapper.appendChild(p);

        history.appendChild(wrapper);
        history.scrollTop = history.scrollHeight;
        
        return wrapper;
    }

    // Grab DOM nodes
    const inputEl = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const suggestionsWrapper = document.getElementById('suggestions-wrapper');
    const suggestionsHeader = document.getElementById('suggestions-header');
    const toolDropdown = document.getElementById('toolDropdown');
    const atButton = document.getElementById('atButton');

    // Load available tools
    async function loadAvailableTools() {
        try {
            const response = await fetch('/chatbot/available_tools');
            if (!response.ok) throw new Error('Failed to load tools');
            const tools = await response.json();
            
            // Clear existing tools
            toolDropdown.innerHTML = '';
            
            // Add tools to dropdown
            for (const toolName of Object.keys(tools)) {
                const toolItem = document.createElement('div');
                toolItem.classList.add('tool-item');
                toolItem.innerHTML = `
                    <img src="{{ url_for('static', filename='images/${toolName}-logo.png') }}" alt="${toolName}" class="tool-icon">
                    <span>${toolName.charAt(0).toUpperCase() + toolName.slice(1)}</span>
                `;
                toolItem.onclick = () => insertTool(toolName);
                toolDropdown.appendChild(toolItem);
            }
        } catch (error) {
            console.error('Error loading tools:', error);
        }
    }

    // Load tools when page loads
    loadAvailableTools();

    // Handle input focus events
    inputEl.addEventListener('focus', () => {
        suggestionsWrapper.style.display = 'none';
        suggestionsHeader.style.display = 'none';
    });

    inputEl.addEventListener('blur', () => {
        suggestionsWrapper.style.display = 'block';
        suggestionsHeader.style.display = 'block';
    });

    // Tool selection handling
    atButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const dropdown = document.getElementById('toolDropdown');
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('toolDropdown');
        const toolSelector = document.querySelector('.tool-selector');
        if (!toolSelector.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });

    function insertTool(tool) {
        const toolText = `@${tool}`;
        const input = document.getElementById('chat-input');
        const start = input.selectionStart;
        const end = input.selectionEnd;
        const text = input.value;
        const before = text.substring(0, start);
        const after = text.substring(end);
        
        input.value = before + toolText + ' ' + after;
        input.focus();
        input.selectionStart = input.selectionEnd = start + toolText.length + 1;
        document.getElementById('toolDropdown').style.display = 'none';
    }

    // When user clicks "send" or presses Enter
    function sendCommand() {
        const raw = inputEl.value.trim();
        if (!raw) return;

        // Append the user's message immediately
        appendMessage('user', raw);
        inputEl.value = '';
        inputEl.focus();

        // Show "thinking" message
        const thinkingMsg = appendMessage('bot', '🤔 Processing...');

        // POST to Flask endpoint
        fetch('/chatbot/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message: raw })
        })
        .then((res) => {
            if (!res.ok) throw new Error('Network response was not OK');
            return res.json();
        })
        .then((data) => {
            // Remove thinking message
            thinkingMsg.remove();
            
            if (data.tool_executed) {
                // Show tool execution status
                appendMessage('bot', '🛠️ Executing command...');
                // Show tool result
                appendMessage('bot', `📊 Result: ${JSON.stringify(data.tool_result, null, 2)}`);
            }
            
            // Show final response
            appendMessage('bot', data.reply);
        })
        .catch((err) => {
            console.error('Error sending command:', err);
            thinkingMsg.remove();
            appendMessage('bot', '⚠️ Error: could not reach server.');
        });
    }

    // Event listeners
    sendBtn.addEventListener('click', sendCommand);
    inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendCommand();
        }
    });
</script>
{% endblock %}

