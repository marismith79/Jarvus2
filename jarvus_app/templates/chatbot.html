{% extends "base.html" %}

{% block title %}Chatbot - Jarvus{% endblock %}

{% block content %}
<div class="chatbot-layout">
    <!-- Workspace Sidebar (empty for now) -->
    <aside class="workspace-sidebar"></aside>

    <!-- Chat Main Area -->
    <section class="chatbot-card">
        <!-- Greeting -->
        <div class="greeting-section">
            <h1 class="greeting-title">Hello, {{ current_user.name or 'User' }}</h1>
            <p class="greeting-subtitle">How can I help you today?</p>
        </div>

        <!-- Suggestions header -->
        <div class="suggestions-header" id="suggestions-header">
            <span class="suggestions-label">Suggestions</span>
            <button class="dropdown-btn">▾</button>
        </div>

        <!-- Suggestion cards -->
        <div class="suggestions-cards-wrapper" id="suggestions-wrapper">
            <div class="suggestions-cards">
                <!-- Card 1 -->
                <div class="card">
                    <div class="card-text">
                        Recap yesterday's all-hands meeting
                    </div>
                    <div class="card-avatar">
                        <img src="https://via.placeholder.com/100" alt="Person">
                    </div>
                    <div class="card-meta">
                        Acme All-hands · Before lunch
                    </div>
                </div>

                <!-- Card 2 -->
                <div class="card">
                    <div class="card-text">
                        Ask "What needs to be addressed in this request for proposal?"
                    </div>
                    <div class="card-image">
                        <img src="https://via.placeholder.com/100x100?text=Docs" alt="Documents">
                    </div>
                    <div class="card-meta">
                        <span class="icon">📄</span> 3 files · This morning
                    </div>
                </div>

                <!-- Card 3 -->
                <div class="card">
                    <div class="card-text">
                        Recap yesterday's all-hands meeting
                    </div>
                    <div class="card-avatar">
                        <img src="https://via.placeholder.com/100" alt="Person">
                    </div>
                    <div class="card-meta">
                        AcmeCo all-hands · This morning
                    </div>
                </div>

                <!-- Card 4 (Salesforce) -->
                <div class="card card-salesforce">
                    <div class="card-text salesforce-text">
                        Update the opportunity to Signed
                    </div>
                    <div class="card-meta salesforce-meta">
                        Project ARR <br><span class="amount">$40,000</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat history -->
        <div id="chat-history" class="chat-history"></div>

        <!-- Chat input bar -->
        <form class="chat-input-bar" onsubmit="event.preventDefault(); sendCommand();">
            <div class="input-buttons">
                <button type="button" class="icon-btn input-plus">+</button>
                <div class="tool-selector">
                    <button type="button" class="icon-btn input-at" id="atButton">@</button>
                    <div class="tool-dropdown" id="toolDropdown">
                        <div class="tool-item" onclick="insertTool('gmail')">
                            <img src="{{ url_for('static', filename='images/gmail-logo.png') }}" alt="Gmail" class="tool-icon">
                            <span>Gmail</span>
                        </div>
                        <div class="tool-item" onclick="insertTool('slack')">
                            <img src="{{ url_for('static', filename='images/slack-logo.png') }}" alt="Slack" class="tool-icon">
                            <span>Slack</span>
                        </div>
                    </div>
                </div>
            </div>
            <input type="text" id="chat-input" class="chat-input" placeholder="Ask or search for anything..." autocomplete="off">
            <button type="submit" class="icon-btn send-btn" id="send-btn">➔</button>
        </form>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Helper to append a message bubble into #chat-history
    function appendMessage(who, text) {
        const history = document.getElementById('chat-history');
        const wrapper = document.createElement('div');
        wrapper.classList.add('message', who);
        
        const p = document.createElement('p');
        p.textContent = text;
        wrapper.appendChild(p);

        history.appendChild(wrapper);
        history.scrollTop = history.scrollHeight;
    }

    // Grab DOM nodes
    const inputEl = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const suggestionsWrapper = document.getElementById('suggestions-wrapper');
    const suggestionsHeader = document.getElementById('suggestions-header');
    const toolDropdown = document.getElementById('toolDropdown');
    const atButton = document.getElementById('atButton');

    // Handle input focus events
    inputEl.addEventListener('focus', () => {
        suggestionsWrapper.style.display = 'none';
        suggestionsHeader.style.display = 'none';
    });

    inputEl.addEventListener('blur', () => {
        suggestionsWrapper.style.display = 'block';
        suggestionsHeader.style.display = 'block';
    });

    // Tool selection handling
    atButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const dropdown = document.getElementById('toolDropdown');
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('toolDropdown');
        const toolSelector = document.querySelector('.tool-selector');
        if (!toolSelector.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });

    function insertTool(tool) {
        const toolText = `@${tool}`;
        const input = document.getElementById('chat-input');
        const start = input.selectionStart;
        const end = input.selectionEnd;
        const text = input.value;
        const before = text.substring(0, start);
        const after = text.substring(end);
        
        input.value = before + toolText + ' ' + after;
        input.focus();
        input.selectionStart = input.selectionEnd = start + toolText.length + 1;
        document.getElementById('toolDropdown').style.display = 'none';
    }

    // When user clicks "send" or presses Enter
    function sendCommand() {
        const raw = inputEl.value.trim();
        if (!raw) return;

        // Append the user's message immediately
        appendMessage('user', raw);
        inputEl.value = '';
        inputEl.focus();

        // POST to Flask endpoint
        fetch('/api/command', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ command: raw })
        })
        .then((res) => {
            if (!res.ok) throw new Error('Network response was not OK');
            return res.json();
        })
        .then((data) => {
            appendMessage('bot', data.reply);
        })
        .catch((err) => {
            console.error('Error sending command:', err);
            appendMessage('bot', '⚠️ Error: could not reach server.');
        });
    }

    // Event listeners
    sendBtn.addEventListener('click', sendCommand);
    inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendCommand();
        }
    });
</script>
{% endblock %}

