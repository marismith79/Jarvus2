{% extends "base.html" %}

{% block title %}Chatbot - Jarvus{% endblock %}

{% block content %}
<div class="chatbot-layout">
    <!-- Chat Main Area -->
    <section class="chatbot-card">
        <!-- Greeting -->
        <div class="greeting-section">
            <h1 class="greeting-title">Hello, {{ current_user.name or 'User' }}</h1>
            <p class="greeting-subtitle">How can I help you today?</p>
        </div>

        <!-- Suggestions header -->
        <div class="suggestions-header" id="suggestions-header">
            <span class="suggestions-label">Suggestions</span>
            <button class="dropdown-btn">▾</button>
        </div>

        <!-- Suggestion cards -->
        <div class="suggestions-cards-wrapper" id="suggestions-wrapper">
            <div class="suggestions-cards">
                <div class="card card-gmail" onclick="insertSuggestion('Check my recent emails')">
                    <div class="card-text gmail-text">
                        Summarize my most recent work emails 
                    </div>
                </div>
                <div class="card card-calendar" onclick="insertSuggestion('Show my upcoming events')">
                    <div class="card-text calendar-text">
                        Show all my upcoming calls
                    </div>
                </div>
                <div class="card card-salesforce" onclick="insertSuggestion('Update the opportunity to Signed')">
                    <div class="card-text salesforce-text">
                        Create a notion database for my sales
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat history -->
        <div id="chat-history" class="chat-history"></div>

        <!-- Chat input bar -->
        <form class="chat-input-bar" onsubmit="event.preventDefault(); sendCommand();">
            <div class="input-buttons">
                <div class="tool-selector">
                    <button type="button" class="icon-btn input-at" id="atButton">@</button>
                    <div class="tool-dropdown" id="toolDropdown">
                        <!-- Tool items will be populated dynamically -->
                    </div>
                </div>
            </div>
            <input type="text" id="chat-input" class="chat-input" placeholder="Ask or search for anything..." autocomplete="off">
            <button type="submit" class="icon-btn send-btn" id="send-btn">➔</button>
        </form>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Store connection status
    const connectedTools = {
        gmail: {{ 'true' if gmail_connected else 'false' }},
        notion: {{ 'true' if notion_connected else 'false' }},
        slack: {{ 'true' if slack_connected else 'false' }},
        zoom: {{ 'true' if zoom_connected else 'false' }}
    };

    // Helper to append a message bubble into #chat-history
    function appendMessage(who, text) {
        const history = document.getElementById('chat-history');
        const wrapper = document.createElement('div');
        wrapper.classList.add('message', who);
        
        const p = document.createElement('p');
        p.textContent = text;
        wrapper.appendChild(p);

        history.appendChild(wrapper);
        history.scrollTop = history.scrollHeight;
        
        return wrapper;
    }

    // Grab DOM nodes
    const inputEl = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const suggestionsWrapper = document.getElementById('suggestions-wrapper');
    const suggestionsHeader = document.getElementById('suggestions-header');
    const toolDropdown = document.getElementById('toolDropdown');
    const atButton = document.getElementById('atButton');
    const dropdownBtn = document.querySelector('.dropdown-btn');

    // Load available tools
    function loadAvailableTools() {
        // Clear existing tools
        toolDropdown.innerHTML = '';
        
        // Add connected tools to dropdown
        let hasConnectedTools = false;
        
        for (const [toolName, isConnected] of Object.entries(connectedTools)) {
            if (isConnected) {
                hasConnectedTools = true;
                const toolItem = document.createElement('div');
                toolItem.classList.add('tool-item');
                toolItem.innerHTML = `
                    <span>${toolName.charAt(0).toUpperCase() + toolName.slice(1)}</span>
                    <span class="checkmark" style="display: none;">✓</span>
                `;
                toolItem.onclick = (e) => {
                    e.stopPropagation(); // Prevent dropdown from closing
                    const checkmark = toolItem.querySelector('.checkmark');
                    // Toggle the checkmark visibility
                    checkmark.style.display = checkmark.style.display === 'none' ? 'inline-block' : 'none';
                };
                toolDropdown.appendChild(toolItem);
            }
        }

        // If no tools are connected, show a message
        if (!hasConnectedTools) {
            const noToolsMessage = document.createElement('div');
            noToolsMessage.classList.add('tool-item');
            noToolsMessage.innerHTML = '<span>No tools connected</span>';
            toolDropdown.appendChild(noToolsMessage);
        }
    }

    // Load tools when page loads
    loadAvailableTools();

    // Tool selection handling
    atButton.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const dropdown = document.getElementById('toolDropdown');
        dropdown.classList.remove('hiding');
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        const dropdown = document.getElementById('toolDropdown');
        const toolSelector = document.querySelector('.tool-selector');
        if (!toolSelector.contains(e.target)) {
            dropdown.classList.add('hiding');
            setTimeout(() => {
                dropdown.style.display = 'none';
                dropdown.classList.remove('hiding');
            }, 150); // Match the transition duration
        }
    });

    // When user clicks "send" or presses Enter
    function sendCommand() {
        const raw = inputEl.value.trim();
        if (!raw) return;

        // Hide suggestions after first message
        suggestionsWrapper.style.display = 'none';
        dropdownBtn.style.transform = 'rotate(90deg)';

        // Append the user's message immediately
        appendMessage('user', raw);
        inputEl.value = '';
        inputEl.focus();

        // Show "thinking" message
        const thinkingMsg = appendMessage('bot', '...');

        // POST to Flask endpoint
        fetch('/chatbot/send', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message: raw })
        })
        .then((res) => {
            if (!res.ok) throw new Error('Network response was not OK');
            return res.json();
        })
        .then((data) => {
            // Remove thinking message
            thinkingMsg.remove();
            
            if (data.tool_executed) {
                // Show tool execution status
                appendMessage('bot', '🛠️ Executing command...');
                // Show tool result
                appendMessage('bot', `📊 Result: ${JSON.stringify(data.tool_result, null, 2)}`);
            }
            
            // Show final response
            appendMessage('bot', data.reply);
        })
        .catch((err) => {
            console.error('Error sending command:', err);
            thinkingMsg.remove();
            appendMessage('bot', '⚠️ Error: could not reach server.');
        });
    }

    // Event listeners
    sendBtn.addEventListener('click', sendCommand);
    inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendCommand();
        }
    });

    // Toggle suggestions visibility
    function toggleSuggestions() {
        const isVisible = suggestionsWrapper.style.display !== 'none';
        suggestionsWrapper.style.display = isVisible ? 'none' : 'block';
        dropdownBtn.style.transform = isVisible ? 'rotate(90deg)' : 'rotate(0deg)';
    }
    
    // Add click handler to the dropdown button
    dropdownBtn.addEventListener('click', toggleSuggestions);

    // Add this function at the beginning of your script section
    function insertSuggestion(text) {
        const input = document.getElementById('chat-input');
        input.value = text;
        input.focus();
    }
</script>
{% endblock %}

