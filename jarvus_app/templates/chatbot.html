{% extends "base.html" %}

{% block title %}Chatbot - Jarvus{% endblock %}

{% block content %}
<style>
    .message p {
        white-space: pre-wrap;
        line-height: 1.5;
        margin: 0;
    }
</style>
<div class="chatbot-layout">
    <!-- Dashboard Sidebar -->
    <aside class="chatbot-dashboard">
        <div class="dashboard-header">
            <button class="cta-button new-agent-btn">New Agent +</button>
        </div>
        <div class="dashboard-content">
            <!-- Agents Section -->
            <div class="sidebar-section">
                <h3 class="section-title">Agents</h3>
                <div class="chat-list">
                    {% for agent in agents %}
                    <div class="chat-item" data-agent-id="{{ agent.id }}">
                        <span class="agent-name">{{ agent.name }}</span>
                        <button class="delete-agent-btn" onclick="deleteAgent('{{ agent.id }}')" title="Delete agent">
                            <svg class="trash-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m3 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Workflows Section -->
            <div class="sidebar-section">
                <h3 class="section-title">Workflows</h3>
                <div class="workflow-tabs">
                    <button class="workflow-tab active" data-tab="scheduled">Scheduled</button>
                    <button class="workflow-tab" data-tab="running">Running</button>
                    <button class="workflow-tab" data-tab="suggested">Suggested</button>
                </div>
                <div class="workflow-content">
                    <div class="workflow-section active" id="scheduled-workflows">
                        <div class="workflow-item">
                            <div class="workflow-icon">ğŸ“…</div>
                            <div class="workflow-details">
                                <div class="workflow-name">Morning Email Review</div>
                                <div class="workflow-time">Daily at 9:00 AM</div>
                            </div>
                        </div>
                        <div class="workflow-item">
                            <div class="workflow-icon">ğŸ“Š</div>
                            <div class="workflow-details">
                                <div class="workflow-name">Weekly Report</div>
                                <div class="workflow-time">Every Monday at 8:00 AM</div>
                            </div>
                        </div>
                    </div>
                    <div class="workflow-section" id="running-workflows">
                        <div class="workflow-item running">
                            <div class="workflow-icon">ğŸ”„</div>
                            <div class="workflow-details">
                                <div class="workflow-name">Email Processing</div>
                                <div class="workflow-status">Running...</div>
                            </div>
                        </div>
                    </div>
                    <div class="workflow-section" id="suggested-workflows">
                        <div class="workflow-item">
                            <div class="workflow-icon">ğŸ’¡</div>
                            <div class="workflow-details">
                                <div class="workflow-name">Calendar Optimization</div>
                                <div class="workflow-desc">Based on your schedule patterns</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Chat Main Area -->
    <section class="chatbot-card" id="main-chat-area" {% if not most_recent_agent %}style="display:none"{% endif %}>

        <!-- Web Search Toggle -->
        <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
            <label for="web-search-toggle" style="margin-right: 0.5rem; font-weight: 500;">Enable Web Search</label>
            <input type="checkbox" id="web-search-toggle" checked />
        </div>

        <!-- Greeting Section -->
        <div class="greeting-section">
            <div id="agent-greeting" class="greeting-title">Select an agent to start chatting</div>
            <div id="agent-subtitle" class="greeting-subtitle">Choose an agent from the sidebar or create a new one</div>
        </div>
        
        <!-- Chat history -->
        <div id="chat-history" class="chat-history"></div>
        <!-- Chat input bar -->
        <form class="chat-input-bar" onsubmit="event.preventDefault(); sendCommand();">
            <input type="text" id="chat-input" class="chat-input" placeholder="Ask or search for anything..." autocomplete="off">
            <button type="submit" class="icon-btn send-btn" id="send-btn">â†’</button>
        </form>
    </section>

    <!-- Right Sidebar - Todo and Calendar -->
    <aside class="right-sidebar">
        <!-- Todo List Panel -->
        <div class="todo-panel">
            <div class="panel-header">
                <h3 class="panel-title">Today's Tasks</h3>
                <div class="todo-buttons">
                    <button class="dev-generate-btn" onclick="generateMorningTodos()" title="Generate todos (dev)">ğŸ¯</button>
                    <button class="add-todo-btn" onclick="addTodoItem()">+</button>
                </div>
            </div>
            <div class="todo-list" id="todo-list">
                <div class="todo-item">
                    <input type="checkbox" class="todo-checkbox">
                    <span class="todo-text">Review morning emails</span>
                    <button class="todo-edit-btn" onclick="editTodo(this)">âœï¸</button>
                    <button class="todo-delete-btn" onclick="deleteTodo(1)">ğŸ—‘ï¸</button>
                </div>
                <div class="todo-item">
                    <input type="checkbox" class="todo-checkbox">
                    <span class="todo-text">Prepare weekly report</span>
                    <button class="todo-edit-btn" onclick="editTodo(this)">âœï¸</button>
                    <button class="todo-delete-btn" onclick="deleteTodo(2)">ğŸ—‘ï¸</button>
                </div>
                <div class="todo-item completed">
                    <input type="checkbox" class="todo-checkbox" checked>
                    <span class="todo-text">Team standup meeting</span>
                    <button class="todo-edit-btn" onclick="editTodo(this)">âœï¸</button>
                    <button class="todo-delete-btn" onclick="deleteTodo(3)">ğŸ—‘ï¸</button>
                </div>
            </div>
        </div>

        <!-- Calendar Panel -->
        <div class="calendar-panel">
            <div class="panel-header">
                <h3 class="panel-title">Calendar</h3>
                <div class="calendar-buttons">
                    <button class="debug-calendar-btn" onclick="debugCalendar()" title="Debug calendar">ğŸ”§</button>
                    <button class="refresh-calendar-btn" onclick="refreshCalendar()">ğŸ”„</button>
                </div>
            </div>
            <div class="calendar-content" id="calendar-content">
                <div class="calendar-loading">Loading calendar...</div>
            </div>
        </div>
    </aside>

    <!-- Centered New Agent Button if no agents -->
    {% if not most_recent_agent %}
    <section id="empty-state" style="flex:1;display:flex;align-items:center;justify-content:center;">
        <button class="cta-button new-agent-btn" style="font-size:1.2rem;padding:1.5rem 2.5rem;">New Agent +</button>
    </section>
    {% endif %}

    <!-- Agent Creation View -->
    <section id="agent-creation-view" style="display: none;">
        <div class="creation-step active" id="step-1">
            <h2>Choose my name...</h2>
            <input type="text" id="agent-name" placeholder="Morning Brew Agent...">
            <button class="next-step-btn">â†“</button>
        </div>
        <div class="creation-step" id="step-2">
            <h2>Choose my tools...</h2>
            <div id="agent-creation-tool-list" class="tool-list-container">
                <!-- Tools are dynamically populated by chatbot.js -->
            </div>
            <button class="next-step-btn">â†“</button>
        </div>
        <div class="creation-step" id="step-3">
            <h2>Describe what I do (optional)</h2>
            <textarea id="agent-description" placeholder="You are an agent that manages my inbox and tells me if people reply to my outreach messages."></textarea>
            <button id="finish-creation-btn">Create Agent</button>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
    window.mostRecentAgentId = {{ most_recent_agent.id if most_recent_agent else 'null' }};
    window.mostRecentAgentName = {{ most_recent_agent.name|tojson if most_recent_agent else 'null' }};
    // Pass connection status to JavaScript
    {% for tool in tool_list -%}
    window.{{ tool.slug }}Connected = {{ 'true' if tool.connected else 'false' }};
    {% endfor %}
    window.toolSlugs = {{ tool_list | map(attribute='slug') | list | tojson }};
</script>
<script src="{{ url_for('static', filename='js/marked.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/chatbot.js') }}?v=4"></script>
{% endblock %}

