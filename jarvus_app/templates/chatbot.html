{% extends "base.html" %}

{% block title %}Chatbot - Jarvus{% endblock %}

{% block content %}
<div class="chatbot-layout">
    <!-- Workspace Sidebar (empty for now) -->
    <aside class="workspace-sidebar"></aside>

    <!-- Chat Main Area -->
    <section class="chatbot-card">
        <!-- Greeting -->
        <div class="greeting-section">
            <h1 class="greeting-title">Hello, Tetsu</h1>
            <p class="greeting-subtitle">How can I help you today?</p>
        </div>

        <!-- Suggestions header -->
        <div class="suggestions-header" id="suggestions-header">
            <span class="suggestions-label">Suggestions</span>
            <button class="dropdown-btn">â–¾</button>
        </div>

        <!-- Suggestion cards -->
        <div class="suggestions-cards-wrapper" id="suggestions-wrapper">
            <div class="suggestions-cards">
                <!-- Card 1 -->
                <div class="card">
                    <div class="card-text">
                        Recap yesterday's all-hands meeting
                    </div>
                    <div class="card-avatar">
                        <img src="https://via.placeholder.com/100" alt="Person">
                    </div>
                    <div class="card-meta">
                        Acme All-hands Â· Before lunch
                    </div>
                </div>

                <!-- Card 2 -->
                <div class="card">
                    <div class="card-text">
                        Ask "What needs to be addressed in this request for proposal?"
                    </div>
                    <div class="card-image">
                        <img src="https://via.placeholder.com/100x100?text=Docs" alt="Documents">
                    </div>
                    <div class="card-meta">
                        <span class="icon">ðŸ“„</span> 3 files Â· This morning
                    </div>
                </div>

                <!-- Card 3 -->
                <div class="card">
                    <div class="card-text">
                        Recap yesterday's all-hands meeting
                    </div>
                    <div class="card-avatar">
                        <img src="https://via.placeholder.com/100" alt="Person">
                    </div>
                    <div class="card-meta">
                        AcmeCo all-hands Â· This morning
                    </div>
                </div>

                <!-- Card 4 (Salesforce) -->
                <div class="card card-salesforce">
                    <div class="card-text salesforce-text">
                        Update the opportunity to Signed
                    </div>
                    <div class="card-meta salesforce-meta">
                        Project ARR <br><span class="amount">$40,000</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat history -->
        <div id="chat-history" class="chat-history"></div>

        <!-- Chat input bar -->
        <form class="chat-input-bar" onsubmit="event.preventDefault(); sendCommand();">
            <button type="button" class="icon-btn input-plus">ï¼‹</button>
            <input type="text" id="chat-input" class="chat-input" placeholder="Ask or search for anything..." autocomplete="off">
            <button type="submit" class="icon-btn send-btn" id="send-btn">âž”</button>
        </form>
    </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Helper to append a message bubble into #chat-history
    function appendMessage(who, text) {
        const history = document.getElementById('chat-history');
        const wrapper = document.createElement('div');
        wrapper.classList.add('message', who);
        
        const p = document.createElement('p');
        p.textContent = text;
        wrapper.appendChild(p);

        history.appendChild(wrapper);
        history.scrollTop = history.scrollHeight;
    }

    // Grab DOM nodes
    const inputEl = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const suggestionsWrapper = document.getElementById('suggestions-wrapper');
    const suggestionsHeader = document.getElementById('suggestions-header');

    // Handle input focus events
    inputEl.addEventListener('focus', () => {
        suggestionsWrapper.style.display = 'none';
        suggestionsHeader.style.display = 'none';
    });

    inputEl.addEventListener('blur', () => {
        suggestionsWrapper.style.display = 'block';
        suggestionsHeader.style.display = 'block';
    });

    // When user clicks "send" or presses Enter
    function sendCommand() {
        const raw = inputEl.value.trim();
        if (!raw) return;

        // Append the user's message immediately
        appendMessage('user', raw);
        inputEl.value = '';
        inputEl.focus();

        // POST to Flask endpoint
        fetch('/api/command', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ command: raw })
        })
        .then((res) => {
            if (!res.ok) throw new Error('Network response was not OK');
            return res.json();
        })
        .then((data) => {
            appendMessage('bot', data.reply);
        })
        .catch((err) => {
            console.error('Error sending command:', err);
            appendMessage('bot', 'âš ï¸ Error: could not reach server.');
        });
    }

    // Event listeners
    sendBtn.addEventListener('click', sendCommand);
    inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendCommand();
        }
    });
</script>
{% endblock %}

